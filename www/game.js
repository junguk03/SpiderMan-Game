// ==================== GAME CONFIGURATION ====================
const CONFIG = {
    gravity: 0.5,
    friction: 0.85,
    airResistance: 0.99,
    playerWidth: 20,
    playerHeight: 40,
    moveSpeed: 5,
    jumpForce: -13,
    wallSlideSpeed: 2,
    wallJumpForce: { x: 10, y: -11 },
    ropeSpeed: 30,
    swingForce: 0.35,
    swingDamping: 0.98,
    maxRopeLength: 350
};

// ==================== GAME STATE ====================
let canvas, ctx;
let gameState = 'start';
let currentLevel = 0;
let totalStars = 0;
let collectedStars = 0;

const keys = { left: false, right: false, jump: false, grapple: false };
let mouseX = 0, mouseY = 0;

let player = {
    x: 0, y: 0, vx: 0, vy: 0,
    width: CONFIG.playerWidth,
    height: CONFIG.playerHeight,
    onGround: false,
    onWall: 0,
    wallJumpCooldown: 0,
    facingRight: true
};

let grapple = {
    active: false, attached: false,
    x: 0, y: 0, vx: 0, vy: 0,
    anchorX: 0, anchorY: 0,
    ropeLength: 0
};

let platforms = [], walls = [], anchors = [], stars = [];
let buttons = []; // 버튼 배열 추가
let hazards = []; // 빨간 발판/벽 (닿으면 죽음)
let movingPlatforms = []; // 움직이는 발판
let door = null;
let spawnPoint = { x: 0, y: 0 };
let camera = { x: 0, y: 0 };

// Tutorial state
let tutorialStep = 0;
let tutorialActions = {
    moved: false, jumped: false, wallJumped: false,
    grappled: false, swung: false, collected: false
};

// ==================== LEVELS ====================
function createLevels() {
    const levels = [];

    // Tutorial Level (Level 0)
    levels.push({
        name: 'Tutorial',
        spawn: { x: 80, y: 300 },
        platforms: [
            { x: 0, y: 350, w: 250, h: 30 },
            { x: 350, y: 350, w: 200, h: 30 },
            { x: 650, y: 320, w: 150, h: 30 },
            { x: 900, y: 280, w: 200, h: 30 },
            { x: 1200, y: 350, w: 250, h: 30 }
        ],
        walls: [
            { x: 900, y: 100, w: 20, h: 180 },
            { x: 1080, y: 100, w: 20, h: 180 }
        ],
        anchors: [
            { x: 450, y: 150 },
            { x: 600, y: 120 },
            { x: 800, y: 100 }
        ],
        stars: [
            { x: 450, y: 220 },
            { x: 990, y: 150 }
        ],
        door: { x: 1350, y: 290 },
        isTutorial: true
    });

    // Level 1-5: Hand-crafted easy levels
    levels.push({
        name: 'Level 1',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 200, y: 370, w: 120, h: 30 },
            { x: 370, y: 350, w: 120, h: 30 },
            { x: 540, y: 370, w: 200, h: 30 }
        ],
        walls: [],
        anchors: [],
        stars: [{ x: 260, y: 320 }, { x: 430, y: 300 }],
        door: { x: 650, y: 310 }
    });

    levels.push({
        name: 'Level 2',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 280, y: 370, w: 120, h: 30 },
            { x: 500, y: 350, w: 150, h: 30 }
        ],
        walls: [],
        anchors: [{ x: 350, y: 180 }],
        stars: [{ x: 350, y: 250 }, { x: 350, y: 130 }],
        door: { x: 560, y: 290 }
    });

    levels.push({
        name: 'Level 3',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 400, y: 370, w: 150, h: 30 },
            { x: 650, y: 370, w: 150, h: 30 }
        ],
        walls: [],
        anchors: [{ x: 270, y: 150 }, { x: 520, y: 150 }],
        stars: [{ x: 270, y: 250 }, { x: 520, y: 250 }],
        door: { x: 720, y: 310 }
    });

    levels.push({
        name: 'Level 4',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 120, h: 30 },
            { x: 350, y: 400, w: 150, h: 30 },
            { x: 650, y: 370, w: 200, h: 30 }
        ],
        walls: [],
        anchors: [{ x: 230, y: 150 }, { x: 500, y: 130 }],
        stars: [{ x: 230, y: 230 }, { x: 500, y: 230 }],
        door: { x: 750, y: 310 }
    });

    levels.push({
        name: 'Level 5',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },
            { x: 500, y: 420, w: 120, h: 30 },
            { x: 750, y: 370, w: 200, h: 30 }
        ],
        walls: [],
        anchors: [{ x: 200, y: 100 }, { x: 400, y: 80 }, { x: 600, y: 100 }],
        stars: [{ x: 300, y: 180 }, { x: 500, y: 160 }],
        door: { x: 850, y: 310 }
    });

    // Level 6 - 첫 스윙 레벨
    levels.push({
        name: 'Level 6',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작
            { x: 400, y: 370, w: 100, h: 30 },         // 중간
            { x: 800, y: 370, w: 150, h: 30 }          // 도착
        ],
        walls: [],
        anchors: [{ x: 250, y: 120 }, { x: 600, y: 100 }],
        stars: [{ x: 250, y: 200 }, { x: 600, y: 180 }],
        door: { x: 880, y: 310 }
    });

    // Level 7 - 벽타기 소개
    levels.push({
        name: 'Level 7',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작
            { x: 500, y: 370, w: 100, h: 30 },         // 중간
            { x: 950, y: 370, w: 150, h: 30 }          // 도착
        ],
        walls: [
            { x: 200, y: 180, w: 20, h: 190 },
            { x: 280, y: 180, w: 20, h: 190 }
        ],
        anchors: [{ x: 400, y: 100 }, { x: 720, y: 80 }],
        stars: [{ x: 240, y: 260 }, { x: 550, y: 150 }, { x: 720, y: 130 }],
        door: { x: 1030, y: 310 }
    });

    // Level 8 - 연속 스윙
    levels.push({
        name: 'Level 8',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작
            { x: 500, y: 370, w: 80, h: 30 },          // 중간
            { x: 1000, y: 370, w: 150, h: 30 }         // 도착
        ],
        walls: [],
        anchors: [{ x: 250, y: 80 }, { x: 500, y: 60 }, { x: 750, y: 80 }],
        stars: [{ x: 350, y: 130 }, { x: 620, y: 110 }, { x: 880, y: 130 }],
        door: { x: 1080, y: 310 }
    });

    // Level 9 - 벽 + 스윙 조합
    levels.push({
        name: 'Level 9',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작
            { x: 500, y: 370, w: 80, h: 30 },          // 중간
            { x: 1000, y: 370, w: 150, h: 30 }         // 도착
        ],
        walls: [
            { x: 700, y: 150, w: 20, h: 220 },
            { x: 780, y: 150, w: 20, h: 220 }
        ],
        anchors: [{ x: 250, y: 100 }, { x: 500, y: 80 }, { x: 900, y: 100 }],
        stars: [{ x: 350, y: 150 }, { x: 740, y: 230 }, { x: 900, y: 150 }],
        door: { x: 1080, y: 310 }
    });

    // Level 10 - 버튼 시스템 도입!
    levels.push({
        name: 'Level 10',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작 (버튼1)
            { x: 500, y: 370, w: 100, h: 30 },         // 중간
            { x: 1000, y: 370, w: 100, h: 30 },        // 버튼2
            { x: 1400, y: 370, w: 150, h: 30 }         // 도착
        ],
        walls: [],
        anchors: [
            { x: 250, y: 80 },
            { x: 500, y: 60 },
            { x: 750, y: 80 },
            { x: 1200, y: 80 }
        ],
        stars: [
            { x: 350, y: 120, active: false, buttonId: 0 },  // 버튼1로 활성화
            { x: 850, y: 100, active: false, buttonId: 1 }   // 버튼2로 활성화
        ],
        buttons: [
            { x: 30, y: 355, targetStarIndex: 0 },     // 시작 플랫폼 버튼
            { x: 1030, y: 355, targetStarIndex: 1 }    // 버튼2 플랫폼
        ],
        door: { x: 1470, y: 310 },
        isButtonLevel: true,
        tutorial: '버튼을 밟아 별을 활성화하세요!'
    });

    // Level 11 - 벽타기 + 스윙 조합
    levels.push({
        name: 'Level 11',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작
            { x: 450, y: 370, w: 100, h: 30 },         // 중간 (넓은 간격)
            { x: 900, y: 370, w: 150, h: 30 }          // 도착
        ],
        walls: [
            { x: 200, y: 180, w: 20, h: 190 },         // 벽타기용 벽 1
            { x: 280, y: 180, w: 20, h: 190 }          // 벽타기용 벽 2
        ],
        anchors: [
            { x: 350, y: 100 },
            { x: 650, y: 80 },
            { x: 800, y: 100 }
        ],
        stars: [
            { x: 240, y: 250 },   // 벽 사이 별
            { x: 550, y: 150 },   // 스윙 별 1
            { x: 750, y: 130 }    // 스윙 별 2
        ],
        door: { x: 980, y: 310 }
    });

    // Level 12 - 연속 스윙 레벨
    levels.push({
        name: 'Level 12',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작
            { x: 550, y: 370, w: 80, h: 30 },          // 중간 착지
            { x: 1100, y: 370, w: 150, h: 30 }         // 도착
        ],
        walls: [],
        anchors: [
            { x: 200, y: 80 },
            { x: 400, y: 60 },
            { x: 650, y: 60 },
            { x: 900, y: 80 }
        ],
        stars: [
            { x: 300, y: 130 },   // 높은 별 1
            { x: 520, y: 100 },   // 높은 별 2
            { x: 780, y: 120 }    // 높은 별 3
        ],
        door: { x: 1170, y: 310 }
    });

    // Level 13 - 높은 스윙 레벨 (왔다갔다 하며 별 수집)
    levels.push({
        name: 'Level 13',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작
            { x: 500, y: 370, w: 100, h: 30 },         // 중간 착지
            { x: 1000, y: 370, w: 150, h: 30 }         // 도착
        ],
        walls: [],  // 벽 없음 - 순수 스윙 레벨
        anchors: [
            { x: 200, y: 50 },    // 첫 번째 앵커 (높이)
            { x: 450, y: 30 },    // 두 번째 앵커 (더 높이)
            { x: 700, y: 30 },    // 세 번째 앵커
            { x: 950, y: 50 }     // 네 번째 앵커
        ],
        stars: [
            { x: 300, y: 100 },   // 높은 곳 별 1
            { x: 550, y: 80 },    // 높은 곳 별 2
            { x: 800, y: 100 }    // 높은 곳 별 3
        ],
        door: { x: 1070, y: 310 }
    });

    // Level 14 - 버튼 2개 + 스윙 조합
    levels.push({
        name: 'Level 14',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작 (버튼1)
            { x: 500, y: 370, w: 100, h: 30 },         // 중간
            { x: 1000, y: 370, w: 100, h: 30 },        // 버튼2
            { x: 1400, y: 370, w: 150, h: 30 }         // 도착
        ],
        walls: [],
        anchors: [
            { x: 250, y: 80 },
            { x: 500, y: 60 },
            { x: 750, y: 80 },
            { x: 1200, y: 80 }
        ],
        stars: [
            { x: 380, y: 120, active: false, buttonId: 0 },  // 버튼1로 활성화
            { x: 900, y: 100, active: false, buttonId: 1 },  // 버튼2로 활성화
            { x: 1200, y: 120 }                              // 일반 별
        ],
        buttons: [
            { x: 30, y: 355, targetStarIndex: 0 },     // 시작 플랫폼 버튼
            { x: 1030, y: 355, targetStarIndex: 1 }    // 버튼2 플랫폼
        ],
        door: { x: 1470, y: 310 },
        isButtonLevel: true
    });

    // Level 15 - 긴 맵 + 벽타기 + 점프맵 스타일
    levels.push({
        name: 'Level 15',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },           // 시작
            // 첫 번째 구간: 스윙해서 넘어가기
            { x: 450, y: 350, w: 60, h: 30 },          // 좁은 발판 1
            { x: 800, y: 320, w: 60, h: 30 },          // 좁은 발판 2
            // 벽타기 구간 (단일 벽)
            { x: 1100, y: 370, w: 80, h: 30 },         // 벽 앞 착지
            { x: 1100, y: 150, w: 60, h: 30 },         // 벽 위 플랫폼 (좁게)
            // 높은 곳 점프맵
            { x: 1350, y: 120, w: 50, h: 30 },         // 높은 좁은 발판 1
            { x: 1550, y: 100, w: 50, h: 30 },         // 높은 좁은 발판 2
            { x: 1750, y: 80, w: 50, h: 30 },          // 높은 좁은 발판 3
            // 버튼 구간
            { x: 1950, y: 100, w: 100, h: 30 },        // 버튼 플랫폼
            // 돌아오는 길
            { x: 2150, y: 370, w: 150, h: 30 }         // 도착
        ],
        walls: [
            { x: 1100, y: 180, w: 20, h: 190 }         // 벽타기용 벽 1개만
        ],
        anchors: [
            { x: 250, y: 80 },    // 시작→첫 발판
            { x: 620, y: 60 },    // 발판1→발판2
            { x: 950, y: 80 },    // 발판2→벽 구간
            { x: 1250, y: 40 },   // 벽 위→높은 발판들
            { x: 1450, y: 30 },
            { x: 1650, y: 30 },
            { x: 1850, y: 30 },
            { x: 2050, y: 50 }    // 버튼→도착
        ],
        stars: [
            { x: 450, y: 280, active: false, buttonId: 0 },   // 버튼으로 활성화
            { x: 800, y: 250, active: false, buttonId: 0 },   // 버튼으로 활성화
            { x: 1200, y: 100 },                               // 벽 위 스윙으로 수집
            { x: 1850, y: 50 }                                 // 높은 곳 별
        ],
        buttons: [
            { x: 1980, y: 85, targetStarIndex: [0, 1] }  // 버튼 (별 0, 1 동시 활성화)
        ],
        door: { x: 2200, y: 310 },
        isButtonLevel: true
    });

    // Level 16 - 연속 좁은 발판 + 스윙
    levels.push({
        name: 'Level 16',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },
            { x: 400, y: 340, w: 50, h: 30 },
            { x: 700, y: 300, w: 50, h: 30 },
            { x: 1000, y: 260, w: 50, h: 30 },
            { x: 1300, y: 220, w: 50, h: 30 },
            { x: 1600, y: 180, w: 50, h: 30 },
            { x: 1900, y: 370, w: 150, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 200, y: 80 },
            { x: 550, y: 60 },
            { x: 850, y: 50 },
            { x: 1150, y: 40 },
            { x: 1450, y: 30 },
            { x: 1750, y: 50 }
        ],
        stars: [
            { x: 300, y: 150 },
            { x: 600, y: 120 },
            { x: 900, y: 100 },
            { x: 1200, y: 80 }
        ],
        door: { x: 1950, y: 310 }
    });

    // Level 17 - 벽타기 연속 + 스윙
    levels.push({
        name: 'Level 17',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },
            { x: 300, y: 370, w: 60, h: 30 },
            { x: 300, y: 150, w: 80, h: 30 },    // 첫 벽 위
            { x: 600, y: 370, w: 60, h: 30 },
            { x: 600, y: 100, w: 80, h: 30 },    // 둘째 벽 위
            { x: 950, y: 60, w: 50, h: 30 },     // 높은 좁은 발판
            { x: 1200, y: 370, w: 150, h: 30 }
        ],
        walls: [
            { x: 300, y: 180, w: 20, h: 190 },   // 단일 벽만
            { x: 600, y: 130, w: 20, h: 240 }    // 단일 벽만
        ],
        anchors: [
            { x: 200, y: 100 },
            { x: 450, y: 50 },
            { x: 750, y: 30 },
            { x: 1050, y: 30 }
        ],
        stars: [
            { x: 400, y: 100 },   // 벽 위 스윙으로 수집
            { x: 700, y: 60 },    // 벽 위 스윙으로 수집
            { x: 850, y: 40 },
            { x: 1100, y: 80 }
        ],
        door: { x: 1280, y: 310 }
    });

    // Level 18 - 극한 스윙 (발판 아주 좁고 멀리)
    levels.push({
        name: 'Level 18',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 100, h: 30 },
            { x: 500, y: 350, w: 40, h: 30 },
            { x: 1000, y: 320, w: 40, h: 30 },
            { x: 1500, y: 280, w: 40, h: 30 },
            { x: 2000, y: 370, w: 150, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 250, y: 60 },
            { x: 500, y: 40 },
            { x: 750, y: 50 },
            { x: 1000, y: 40 },
            { x: 1250, y: 50 },
            { x: 1500, y: 40 },
            { x: 1750, y: 60 }
        ],
        stars: [
            { x: 350, y: 100 },
            { x: 750, y: 80 },
            { x: 1250, y: 70 },
            { x: 1750, y: 100 }
        ],
        door: { x: 2050, y: 310 }
    });

    // Level 19 - 복잡하지만 여유있는 맵
    levels.push({
        name: 'Level 19',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 400, y: 370, w: 100, h: 30 },
            { x: 700, y: 350, w: 100, h: 30 },
            { x: 1000, y: 320, w: 100, h: 30 },
            { x: 1000, y: 150, w: 120, h: 30 },   // 벽 위
            { x: 1350, y: 120, w: 80, h: 30 },
            { x: 1650, y: 100, w: 80, h: 30 },
            { x: 1950, y: 370, w: 200, h: 30 }
        ],
        walls: [
            { x: 1000, y: 180, w: 20, h: 140 }    // 단일 벽만
        ],
        anchors: [
            { x: 250, y: 100 },
            { x: 550, y: 80 },
            { x: 850, y: 70 },
            { x: 1200, y: 40 },
            { x: 1500, y: 30 },
            { x: 1800, y: 40 }
        ],
        stars: [
            { x: 300, y: 200 },
            { x: 600, y: 180 },
            { x: 1150, y: 100 },   // 벽 옆 열린 공간으로 이동
            { x: 1450, y: 60 },
            { x: 1750, y: 50 }
        ],
        door: { x: 2050, y: 310 }
    });

    // Level 20 - 위험요소 도입! (2층 구조, 버튼으로 별 활성화)
    levels.push({
        name: 'Level 20',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층 (바닥)
            { x: 0, y: 370, w: 200, h: 30 },
            { x: 400, y: 370, w: 150, h: 30 },
            { x: 800, y: 370, w: 150, h: 30 },
            { x: 1200, y: 370, w: 200, h: 30 },
            { x: 1600, y: 370, w: 150, h: 30 },
            { x: 2000, y: 370, w: 200, h: 30 },
            // 2층
            { x: 600, y: 200, w: 150, h: 30 },
            { x: 1000, y: 180, w: 150, h: 30 },
            { x: 1400, y: 160, w: 150, h: 30 },
            { x: 1800, y: 180, w: 150, h: 30 },    // 버튼 플랫폼
            // 문 플랫폼
            { x: 2400, y: 370, w: 150, h: 30 }
        ],
        walls: [
            { x: 600, y: 230, w: 20, h: 140 },
            { x: 1200, y: 200, w: 20, h: 170 }
        ],
        anchors: [
            { x: 300, y: 150 },
            { x: 550, y: 100 },
            { x: 850, y: 80 },
            { x: 1150, y: 60 },
            { x: 1500, y: 50 },
            { x: 1750, y: 80 },
            { x: 2100, y: 100 },
            { x: 2300, y: 150 }
        ],
        hazards: [
            { x: 280, y: 340, w: 100, h: 30 },     // 빨간 바닥 1
            { x: 620, y: 340, w: 100, h: 30 },     // 빨간 바닥 2
            { x: 1020, y: 340, w: 100, h: 30 },    // 빨간 바닥 3
            { x: 1470, y: 340, w: 100, h: 30 },    // 빨간 바닥 4
            { x: 1870, y: 340, w: 100, h: 30 }     // 빨간 바닥 5
        ],
        stars: [
            { x: 500, y: 300, active: false, buttonId: 0 },
            { x: 900, y: 280, active: false, buttonId: 0 },
            { x: 1300, y: 300, active: false, buttonId: 0 },
            { x: 1700, y: 280 }
        ],
        buttons: [
            { x: 1830, y: 165, targetStarIndex: [0, 1, 2] }
        ],
        door: { x: 2450, y: 310 },
        isButtonLevel: true,
        tutorial: '⚠️ 빨간 발판에 닿으면 죽습니다! 2층 버튼을 눌러 별을 활성화하세요!'
    });

    // Level 21 - 긴 2층 맵 (왼쪽 아래 시작 → 오른쪽 위 버튼 → 별 먹고 왼쪽 위 문)
    levels.push({
        name: 'Level 21',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층 (바닥)
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 350, y: 370, w: 100, h: 30 },
            { x: 650, y: 370, w: 100, h: 30 },
            { x: 950, y: 370, w: 100, h: 30 },
            { x: 1250, y: 370, w: 100, h: 30 },
            { x: 1550, y: 370, w: 100, h: 30 },
            { x: 1850, y: 370, w: 100, h: 30 },
            { x: 2150, y: 370, w: 150, h: 30 },
            // 2층 (왼쪽에서 오른쪽)
            { x: 2150, y: 180, w: 120, h: 30 },    // 오른쪽 위 - 버튼
            { x: 1750, y: 160, w: 100, h: 30 },
            { x: 1350, y: 140, w: 100, h: 30 },
            { x: 950, y: 120, w: 100, h: 30 },
            { x: 550, y: 100, w: 100, h: 30 },
            { x: 150, y: 120, w: 120, h: 30 }      // 왼쪽 위 - 문
        ],
        walls: [
            { x: 2150, y: 210, w: 20, h: 160 }
        ],
        anchors: [
            { x: 250, y: 200 },
            { x: 500, y: 180 },
            { x: 750, y: 160 },
            { x: 1100, y: 60 },
            { x: 1500, y: 50 },
            { x: 1900, y: 60 },
            { x: 2050, y: 100 },
            { x: 400, y: 50 }
        ],
        hazards: [
            { x: 200, y: 340, w: 80, h: 30 },
            { x: 500, y: 340, w: 80, h: 30 },
            { x: 800, y: 340, w: 80, h: 30 },
            { x: 1100, y: 340, w: 80, h: 30 },
            { x: 1400, y: 340, w: 80, h: 30 },
            { x: 1700, y: 340, w: 80, h: 30 },
            { x: 2000, y: 340, w: 80, h: 30 },
            // 2층 빨간 벽
            { x: 1200, y: 80, w: 20, h: 60 },
            { x: 800, y: 60, w: 20, h: 60 }
        ],
        stars: [
            { x: 700, y: 300, active: false, buttonId: 0 },
            { x: 1100, y: 300, active: false, buttonId: 0 },
            { x: 1500, y: 300, active: false, buttonId: 0 },
            { x: 1000, y: 70 }
        ],
        buttons: [
            { x: 2180, y: 165, targetStarIndex: [0, 1, 2] }
        ],
        door: { x: 180, y: 60 },
        isButtonLevel: true
    });

    // Level 22 - 복잡한 2층 미로 (위험요소 가득)
    levels.push({
        name: 'Level 22',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층
            { x: 0, y: 370, w: 120, h: 30 },
            { x: 300, y: 370, w: 80, h: 30 },
            { x: 550, y: 370, w: 80, h: 30 },
            { x: 800, y: 370, w: 80, h: 30 },
            { x: 1100, y: 370, w: 80, h: 30 },
            { x: 1400, y: 370, w: 80, h: 30 },
            { x: 1700, y: 370, w: 100, h: 30 },
            { x: 2000, y: 370, w: 100, h: 30 },
            { x: 2300, y: 370, w: 150, h: 30 },
            // 2층
            { x: 2300, y: 150, w: 120, h: 30 },    // 버튼 플랫폼
            { x: 1900, y: 130, w: 80, h: 30 },
            { x: 1500, y: 110, w: 80, h: 30 },
            { x: 1100, y: 90, w: 80, h: 30 },
            { x: 700, y: 70, w: 80, h: 30 },
            { x: 300, y: 90, w: 120, h: 30 }       // 문
        ],
        walls: [
            { x: 2300, y: 180, w: 20, h: 190 }
        ],
        anchors: [
            { x: 200, y: 200 },
            { x: 450, y: 180 },
            { x: 700, y: 160 },
            { x: 950, y: 50 },
            { x: 1300, y: 40 },
            { x: 1700, y: 50 },
            { x: 2100, y: 80 },
            { x: 500, y: 40 }
        ],
        hazards: [
            // 1층 빨간 바닥
            { x: 170, y: 340, w: 80, h: 30 },
            { x: 420, y: 340, w: 80, h: 30 },
            { x: 670, y: 340, w: 80, h: 30 },
            { x: 920, y: 340, w: 80, h: 30 },
            { x: 1220, y: 340, w: 80, h: 30 },
            { x: 1520, y: 340, w: 80, h: 30 },
            { x: 1850, y: 340, w: 80, h: 30 },
            { x: 2150, y: 340, w: 80, h: 30 },
            // 2층 빨간 벽
            { x: 1050, y: 40, w: 20, h: 50 },
            { x: 1650, y: 50, w: 20, h: 60 },
            { x: 850, y: 30, w: 20, h: 40 }
        ],
        stars: [
            { x: 400, y: 280, active: false, buttonId: 0 },
            { x: 700, y: 280, active: false, buttonId: 0 },
            { x: 1000, y: 280, active: false, buttonId: 0 },
            { x: 1300, y: 280, active: false, buttonId: 0 },
            { x: 1200, y: 50 }
        ],
        buttons: [
            { x: 2330, y: 135, targetStarIndex: [0, 1, 2, 3] }
        ],
        door: { x: 330, y: 30 },
        isButtonLevel: true
    });

    // Level 23 - 위험한 2층 (버튼 2개)
    levels.push({
        name: 'Level 23',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층
            { x: 0, y: 370, w: 120, h: 30 },
            { x: 350, y: 370, w: 80, h: 30 },
            { x: 650, y: 370, w: 80, h: 30 },
            { x: 1000, y: 370, w: 80, h: 30 },
            { x: 1350, y: 370, w: 100, h: 30 },     // 버튼1
            { x: 1700, y: 370, w: 80, h: 30 },
            { x: 2000, y: 370, w: 80, h: 30 },
            { x: 2300, y: 370, w: 100, h: 30 },
            { x: 2600, y: 370, w: 150, h: 30 },
            // 2층
            { x: 2600, y: 140, w: 120, h: 30 },    // 버튼2
            { x: 2200, y: 120, w: 80, h: 30 },
            { x: 1800, y: 100, w: 80, h: 30 },
            { x: 1400, y: 80, w: 80, h: 30 },
            { x: 1000, y: 60, w: 80, h: 30 },
            { x: 600, y: 80, w: 80, h: 30 },
            { x: 200, y: 100, w: 120, h: 30 }      // 문
        ],
        walls: [
            { x: 2600, y: 170, w: 20, h: 200 }
        ],
        anchors: [
            { x: 200, y: 200 },
            { x: 500, y: 180 },
            { x: 850, y: 160 },
            { x: 1200, y: 40 },
            { x: 1600, y: 30 },
            { x: 2000, y: 40 },
            { x: 2400, y: 60 },
            { x: 800, y: 30 },
            { x: 400, y: 40 }
        ],
        hazards: [
            // 1층 빨간 바닥
            { x: 180, y: 340, w: 100, h: 30 },
            { x: 480, y: 340, w: 100, h: 30 },
            { x: 800, y: 340, w: 120, h: 30 },
            { x: 1150, y: 340, w: 100, h: 30 },
            { x: 1530, y: 340, w: 100, h: 30 },
            { x: 1850, y: 340, w: 80, h: 30 },
            { x: 2150, y: 340, w: 80, h: 30 },
            { x: 2450, y: 340, w: 80, h: 30 },
            // 2층 빨간 벽
            { x: 1300, y: 30, w: 20, h: 50 },
            { x: 1900, y: 40, w: 20, h: 60 },
            { x: 700, y: 30, w: 20, h: 50 }
        ],
        stars: [
            { x: 500, y: 280, active: false, buttonId: 0 },
            { x: 850, y: 280, active: false, buttonId: 0 },
            { x: 1500, y: 280, active: false, buttonId: 1 },
            { x: 1900, y: 280, active: false, buttonId: 1 },
            { x: 1100, y: 30 }
        ],
        buttons: [
            { x: 1370, y: 355, targetStarIndex: [0, 1] },
            { x: 2630, y: 125, targetStarIndex: [2, 3] }
        ],
        door: { x: 230, y: 40 },
        isButtonLevel: true
    });

    // Level 24 - 극한 3층 구조
    levels.push({
        name: 'Level 24',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층 (바닥)
            { x: 0, y: 370, w: 120, h: 30 },
            { x: 350, y: 370, w: 60, h: 30 },
            { x: 600, y: 370, w: 60, h: 30 },
            { x: 900, y: 370, w: 60, h: 30 },
            { x: 1200, y: 370, w: 60, h: 30 },
            { x: 1500, y: 370, w: 60, h: 30 },
            { x: 1800, y: 370, w: 60, h: 30 },
            { x: 2100, y: 370, w: 60, h: 30 },
            { x: 2400, y: 370, w: 60, h: 30 },
            { x: 2700, y: 370, w: 120, h: 30 },
            // 2층
            { x: 2700, y: 230, w: 100, h: 30 },
            { x: 2300, y: 210, w: 60, h: 30 },
            { x: 1900, y: 190, w: 60, h: 30 },
            { x: 1500, y: 170, w: 60, h: 30 },
            { x: 1100, y: 150, w: 60, h: 30 },
            { x: 700, y: 170, w: 60, h: 30 },
            { x: 300, y: 190, w: 80, h: 30 },
            // 3층 (꼭대기) - 버튼
            { x: 300, y: 50, w: 100, h: 30 },
            { x: 700, y: 30, w: 60, h: 30 },
            { x: 1100, y: 10, w: 80, h: 30 },       // 버튼 플랫폼
            // 문 (2층 왼쪽)
            { x: 50, y: 190, w: 100, h: 30 }
        ],
        walls: [
            { x: 2700, y: 260, w: 20, h: 110 },
            { x: 300, y: 220, w: 20, h: 150 }
        ],
        anchors: [
            { x: 200, y: 250 },
            { x: 500, y: 230 },
            { x: 800, y: 100 },
            { x: 500, y: 0 },
            { x: 900, y: -20 },
            { x: 1300, y: 80 },
            { x: 1700, y: 100 },
            { x: 2100, y: 120 },
            { x: 2500, y: 140 },
            { x: 150, y: 100 }
        ],
        hazards: [
            // 1층 빨간 바닥
            { x: 180, y: 340, w: 100, h: 30 },
            { x: 450, y: 340, w: 80, h: 30 },
            { x: 720, y: 340, w: 100, h: 30 },
            { x: 1020, y: 340, w: 100, h: 30 },
            { x: 1320, y: 340, w: 100, h: 30 },
            { x: 1620, y: 340, w: 100, h: 30 },
            { x: 1920, y: 340, w: 100, h: 30 },
            { x: 2220, y: 340, w: 100, h: 30 },
            { x: 2520, y: 340, w: 100, h: 30 },
            // 2층/3층 빨간 벽
            { x: 600, y: 0, w: 20, h: 30 },
            { x: 1000, y: 100, w: 20, h: 50 }
        ],
        stars: [
            { x: 500, y: 280, active: false, buttonId: 0 },
            { x: 1000, y: 280, active: false, buttonId: 0 },
            { x: 1500, y: 280, active: false, buttonId: 0 },
            { x: 2000, y: 280, active: false, buttonId: 0 },
            { x: 2500, y: 280, active: false, buttonId: 0 },
            { x: 800, y: -20 }
        ],
        buttons: [
            { x: 1110, y: -5, targetStarIndex: [0, 1, 2, 3, 4] }
        ],
        door: { x: 70, y: 130 },
        isButtonLevel: true
    });

    levels.push({
        name: 'Level 25',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 점점 높아지는 구조
            { x: 0, y: 370, w: 300, h: 30 },
            { x: 600, y: 320, w: 250, h: 30 },
            { x: 1150, y: 260, w: 250, h: 30 },
            { x: 1700, y: 190, w: 250, h: 30 },
            { x: 2250, y: 120, w: 250, h: 30 },
            { x: 2800, y: 50, w: 300, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 450, y: 180 },
            { x: 900, y: 120 },
            { x: 1450, y: 80 },
            { x: 2000, y: 40 },
            { x: 2550, y: 0 }
        ],
        hazards: [
            { x: 380, y: 250, w: 20, h: 120 },
            { x: 1050, y: 200, w: 20, h: 120 },
            { x: 2150, y: 60, w: 20, h: 130 }
        ],
        stars: [
            { x: 450, y: 250 },
            { x: 900, y: 180 },
            { x: 1450, y: 130 },
            { x: 2000, y: 80 },
            { x: 2550, y: 20 }
        ],
        door: { x: 2950, y: -10 }
    });


    // ===== Level 26-30: 깔끔하고 넓은 디자인 =====

    // Level 26 - 넓고 깔끔한 2층 맵 (앵커 최소화)
    levels.push({
        name: 'Level 26',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층 - 넓은 발판
            { x: 0, y: 370, w: 200, h: 30 },
            { x: 500, y: 370, w: 200, h: 30 },
            { x: 1000, y: 370, w: 200, h: 30 },
            { x: 1500, y: 370, w: 200, h: 30 },
            { x: 2000, y: 370, w: 200, h: 30 },
            // 2층 - 1층과 거리 넓게 (y: 100)
            { x: 700, y: 100, w: 200, h: 30 },
            { x: 1200, y: 80, w: 200, h: 30 },
            { x: 1700, y: 100, w: 200, h: 30 },
            // 문
            { x: 2400, y: 370, w: 200, h: 30 }
        ],
        walls: [],
        anchors: [
            // 발판 사이마다 하나씩만
            { x: 350, y: 200 },
            { x: 850, y: 200 },
            { x: 1350, y: 200 },
            { x: 1850, y: 200 },
            // 2층 앵커
            { x: 950, y: 40 },
            { x: 1450, y: 30 }
        ],
        hazards: [
            // 빨간 벽 2개만
            { x: 600, y: 250, w: 20, h: 120 },
            { x: 1400, y: 220, w: 20, h: 150 }
        ],
        stars: [
            { x: 350, y: 280 },
            { x: 850, y: 50 },
            { x: 1350, y: 30 },
            { x: 1850, y: 280 }
        ],
        door: { x: 2500, y: 310 }
    });

    // Level 27 - 오른쪽으로 가면서 2층으로 올라가기
    levels.push({
        name: 'Level 27',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층에서 시작
            { x: 0, y: 370, w: 250, h: 30 },
            { x: 500, y: 370, w: 200, h: 30 },
            // 1.5층 (중간)
            { x: 1000, y: 280, w: 200, h: 30 },
            // 2층
            { x: 1500, y: 180, w: 200, h: 30 },
            { x: 2000, y: 120, w: 200, h: 30 },
            // 도착
            { x: 2500, y: 80, w: 250, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 380, y: 200 },
            { x: 750, y: 150 },
            { x: 1250, y: 100 },
            { x: 1750, y: 50 },
            { x: 2250, y: 30 }
        ],
        hazards: [
            { x: 900, y: 320, w: 80, h: 50 },
            { x: 1900, y: 160, w: 20, h: 80 }
        ],
        stars: [
            { x: 380, y: 280 },
            { x: 750, y: 200 },
            { x: 1250, y: 150 },
            { x: 1750, y: 80 },
            { x: 2250, y: 40 }
        ],
        door: { x: 2600, y: 20 }
    });

    // Level 28 - 넓은 2층 왕복 (버튼 1개)
    levels.push({
        name: 'Level 28',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층 - 넓은 발판
            { x: 0, y: 370, w: 250, h: 30 },
            { x: 600, y: 370, w: 200, h: 30 },
            { x: 1200, y: 370, w: 200, h: 30 },
            { x: 1800, y: 370, w: 200, h: 30 },
            { x: 2400, y: 370, w: 250, h: 30 },
            // 2층 (y: 80, 1층과 거리 290)
            { x: 2400, y: 80, w: 200, h: 30 },    // 버튼
            { x: 1800, y: 60, w: 200, h: 30 },
            { x: 1200, y: 80, w: 200, h: 30 },
            { x: 600, y: 100, w: 200, h: 30 },
            { x: 0, y: 120, w: 250, h: 30 }       // 문
        ],
        walls: [
            { x: 2400, y: 110, w: 20, h: 260 }
        ],
        anchors: [
            { x: 400, y: 200 },
            { x: 900, y: 180 },
            { x: 1500, y: 180 },
            { x: 2100, y: 200 },
            // 2층
            { x: 2100, y: 30 },
            { x: 1500, y: 20 },
            { x: 900, y: 30 },
            { x: 300, y: 50 }
        ],
        hazards: [
            { x: 450, y: 300, w: 100, h: 70 },
            { x: 1050, y: 300, w: 100, h: 70 },
            { x: 1650, y: 300, w: 100, h: 70 }
        ],
        stars: [
            { x: 400, y: 280, active: false, buttonId: 0 },
            { x: 900, y: 280, active: false, buttonId: 0 },
            { x: 1500, y: 280, active: false, buttonId: 0 },
            { x: 2100, y: 280, active: false, buttonId: 0 },
            { x: 1500, y: 30 }
        ],
        buttons: [
            { x: 2480, y: 65, targetStarIndex: [0, 1, 2, 3] }
        ],
        door: { x: 100, y: 60 },
        isButtonLevel: true
    });

    // Level 29 - 점점 올라가는 넓은 맵
    levels.push({
        name: 'Level 29',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층 (바닥)
            { x: 0, y: 370, w: 100, h: 30 },
            { x: 300, y: 370, w: 50, h: 30 },
            { x: 550, y: 370, w: 50, h: 30 },
            { x: 800, y: 370, w: 50, h: 30 },
            { x: 1050, y: 370, w: 50, h: 30 },
            { x: 1300, y: 370, w: 50, h: 30 },
            { x: 1550, y: 370, w: 50, h: 30 },
            { x: 1800, y: 370, w: 50, h: 30 },
            { x: 2050, y: 370, w: 50, h: 30 },
            { x: 2300, y: 370, w: 50, h: 30 },
            { x: 2550, y: 370, w: 50, h: 30 },
            { x: 2800, y: 370, w: 100, h: 30 },
            // 2층
            { x: 2800, y: 220, w: 80, h: 30 },     // 버튼1
            { x: 2450, y: 200, w: 50, h: 30 },
            { x: 2100, y: 180, w: 50, h: 30 },
            { x: 1750, y: 160, w: 50, h: 30 },
            { x: 1400, y: 140, w: 50, h: 30 },
            { x: 1050, y: 160, w: 50, h: 30 },
            { x: 700, y: 180, w: 50, h: 30 },
            { x: 350, y: 200, w: 80, h: 30 },
            // 3층 (버튼2 및 문)
            { x: 350, y: 50, w: 80, h: 30 },       // 버튼2
            { x: 700, y: 30, w: 50, h: 30 },
            { x: 1050, y: 10, w: 50, h: 30 },
            { x: 1400, y: -10, w: 80, h: 30 },     // 문
        ],
        walls: [
            { x: 2800, y: 250, w: 20, h: 120 },
            { x: 350, y: 230, w: 20, h: 140 },
            { x: 350, y: 80, w: 20, h: 120 }
        ],
        anchors: [
            { x: 200, y: 250 },
            { x: 450, y: 230 },
            { x: 750, y: 100 },
            { x: 550, y: 0 },
            { x: 900, y: -20 },
            { x: 1250, y: -40 },
            { x: 1550, y: 70 },
            { x: 1900, y: 90 },
            { x: 2250, y: 110 },
            { x: 2600, y: 130 },
            { x: 150, y: 130 }
        ],
        hazards: [
            // 1층 빨간 바닥
            { x: 150, y: 340, w: 80, h: 30 },
            { x: 400, y: 340, w: 80, h: 30 },
            { x: 650, y: 340, w: 80, h: 30 },
            { x: 900, y: 340, w: 80, h: 30 },
            { x: 1150, y: 340, w: 80, h: 30 },
            { x: 1400, y: 340, w: 80, h: 30 },
            { x: 1900, y: 340, w: 80, h: 30 },
            { x: 2150, y: 340, w: 80, h: 30 },
            { x: 2400, y: 340, w: 80, h: 30 },
            { x: 2650, y: 340, w: 80, h: 30 },
            // 2층/3층 빨간 벽
            { x: 600, y: -10, w: 20, h: 40 },
            { x: 950, y: -30, w: 20, h: 40 },
            { x: 1800, y: 90, w: 20, h: 70 },
            { x: 1200, y: 80, w: 20, h: 60 }
        ],
        stars: [
            { x: 450, y: 280, active: false, buttonId: 0 },
            { x: 900, y: 280, active: false, buttonId: 0 },
            { x: 1350, y: 280, active: false, buttonId: 0 },
            { x: 1800, y: 280, active: false, buttonId: 1 },
            { x: 2250, y: 280, active: false, buttonId: 1 },
            { x: 2700, y: 280, active: false, buttonId: 1 },
            { x: 1100, y: -40 }
        ],
        buttons: [
            { x: 2810, y: 205, targetStarIndex: [0, 1, 2] },
            { x: 360, y: 35, targetStarIndex: [3, 4, 5] }
        ],
        door: { x: 1410, y: -60 },
        isButtonLevel: true
    });

    // Level 30 - 움직이는 발판 입문 (간단한 구조)
    levels.push({
        name: 'Level 30',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 200, h: 30 },       // 시작 발판
            { x: 600, y: 370, w: 200, h: 30 }       // 도착 발판 + 문
        ],
        walls: [],
        anchors: [],
        hazards: [],
        movingPlatforms: [
            { x: 220, y: 370, w: 120, h: 25, type: 'horizontal', range: 250, speed: 1.5 }
        ],
        stars: [
            { x: 350, y: 300 },
            { x: 500, y: 300 }
        ],
        door: { x: 680, y: 310 }
    });

    // Level 31 - 움직이는 발판 + 줄타기 조합
    levels.push({
        name: 'Level 31',
        spawn: { x: 50, y: 320 },
        platforms: [
            // 1층
            { x: 0, y: 370, w: 200, h: 30 },         // 시작 발판
            { x: 550, y: 370, w: 250, h: 30 },        // 중간 발판 (문)
            // 2층 (왼쪽으로 펼쳐진 발판들)
            { x: 100, y: 150, w: 150, h: 25 },        // 2층 첫번째
            { x: -200, y: 130, w: 150, h: 25 },       // 2층 두번째
            { x: -500, y: 110, w: 150, h: 25 },       // 2층 세번째
            { x: -800, y: 130, w: 150, h: 25 },       // 2층 네번째 (끝)
        ],
        walls: [],
        anchors: [
            { x: 500, y: 50 },    // 위아래 블럭 타고 올라간 뒤 왼쪽으로 스윙
            { x: 0, y: 30 },      // 2층 발판 사이 스윙용
            { x: -350, y: 10 },   // 2층 발판 사이 스윙용
            { x: -650, y: 30 },   // 2층 끝쪽 스윙용
        ],
        hazards: [],
        movingPlatforms: [
            // 1층: 시작→중간 좌우 이동
            { x: 220, y: 370, w: 120, h: 25, type: 'horizontal', range: 200, speed: 1.5 },
            // 중간 발판 오른쪽: 위아래 이동 (1층→2층 연결)
            { x: 820, y: 370, w: 100, h: 25, type: 'vertical', range: -230, speed: 1.2 }
        ],
        stars: [
            { x: 150, y: 90 },     // 2층 첫번째 발판 위
            { x: -150, y: 70 },    // 2층 두번째 발판 위
            { x: -450, y: 50 },    // 2층 세번째 발판 위
            { x: -750, y: 70 },    // 2층 네번째 발판 위
        ],
        door: { x: 620, y: 310 }
    });

    // Level 32 - 움직이는 발판 위에서 빨간 벽 피하기
    levels.push({
        name: 'Level 32',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },           // 시작 발판
            { x: 2400, y: 370, w: 200, h: 30 }          // 도착 발판 + 문
        ],
        walls: [],
        anchors: [
            { x: 500, y: 200 },     // 첫번째 벽 위 스윙용
            { x: 1100, y: 180 },    // 두번째 벽 위 스윙용
            { x: 1700, y: 160 },    // 세번째 벽 위 스윙용
            { x: 2200, y: 200 },    // 마지막 벽 위 스윙용
        ],
        hazards: [
            // 빨간 벽 장애물들 (움직이는 발판 경로 위에 세워져 있음)
            { x: 450, y: 270, w: 20, h: 100 },    // 1번 벽 (낮음 - 점프로 가능)
            { x: 800, y: 220, w: 20, h: 150 },    // 2번 벽 (높음 - 줄타기 필요)
            { x: 1150, y: 250, w: 20, h: 120 },   // 3번 벽 (중간)
            { x: 1500, y: 200, w: 20, h: 170 },   // 4번 벽 (높음 - 줄타기 필요)
            { x: 1850, y: 260, w: 20, h: 110 },   // 5번 벽 (중간)
            { x: 2150, y: 230, w: 20, h: 140 },   // 6번 벽 (높음)
        ],
        movingPlatforms: [
            // 긴 움직이는 발판 - 시작부터 끝까지 이동
            { x: 170, y: 370, w: 150, h: 25, type: 'horizontal', range: 2080, speed: 1.8 }
        ],
        stars: [
            { x: 350, y: 300 },     // 1번 벽 앞
            { x: 650, y: 280 },     // 1-2번 벽 사이
            { x: 1000, y: 290 },    // 2-3번 벽 사이
            { x: 1350, y: 280 },    // 3-4번 벽 사이
            { x: 2000, y: 290 },    // 5-6번 벽 사이
        ],
        door: { x: 2450, y: 310 }
    });

    // Level 33 - 위아래 움직이는 발판 + 빨간 바닥
    levels.push({
        name: 'Level 33',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 400, y: 370, w: 100, h: 30 },
            { x: 800, y: 370, w: 100, h: 30 },
            { x: 1200, y: 370, w: 100, h: 30 },
            { x: 1600, y: 370, w: 200, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 250, y: 200 },
            { x: 600, y: 180 },
            { x: 1000, y: 200 },
            { x: 1400, y: 180 }
        ],
        hazards: [
            { x: 150, y: 390, w: 250, h: 20 },
            { x: 500, y: 390, w: 300, h: 20 },
            { x: 900, y: 390, w: 300, h: 20 },
            { x: 1300, y: 390, w: 300, h: 20 }
        ],
        movingPlatforms: [
            { x: 200, y: 370, w: 80, h: 25, type: 'vertical', range: -150, speed: 1.2 },
            { x: 550, y: 370, w: 80, h: 25, type: 'vertical', range: -180, speed: 1.5 },
            { x: 950, y: 370, w: 80, h: 25, type: 'vertical', range: -150, speed: 1.0 },
            { x: 1350, y: 370, w: 80, h: 25, type: 'vertical', range: -180, speed: 1.3 }
        ],
        stars: [
            { x: 230, y: 180 },
            { x: 580, y: 150 },
            { x: 980, y: 180 },
            { x: 1380, y: 150 }
        ],
        door: { x: 1680, y: 310 }
    });

    // Level 34 - 지그재그 올라가는 움직이는 발판
    levels.push({
        name: 'Level 34',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 1800, y: 150, w: 200, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 500, y: 100 },
            { x: 900, y: 50 },
            { x: 1300, y: 80 },
            { x: 1600, y: 100 }
        ],
        hazards: [
            { x: 300, y: 300, w: 20, h: 70 },
            { x: 700, y: 250, w: 20, h: 80 },
            { x: 1100, y: 200, w: 20, h: 90 },
            { x: 1500, y: 150, w: 20, h: 100 }
        ],
        movingPlatforms: [
            { x: 180, y: 350, w: 100, h: 25, type: 'horizontal', range: 150, speed: 1.5 },
            { x: 450, y: 300, w: 100, h: 25, type: 'horizontal', range: 180, speed: 1.8 },
            { x: 750, y: 250, w: 100, h: 25, type: 'horizontal', range: 150, speed: 1.5 },
            { x: 1050, y: 200, w: 100, h: 25, type: 'horizontal', range: 180, speed: 2.0 },
            { x: 1350, y: 150, w: 100, h: 25, type: 'horizontal', range: 150, speed: 1.5 }
        ],
        stars: [
            { x: 350, y: 280 },
            { x: 650, y: 230 },
            { x: 950, y: 180 },
            { x: 1250, y: 130 },
            { x: 1550, y: 80 }
        ],
        door: { x: 1860, y: 90 }
    });

    // Level 35 - 교차하는 움직이는 발판
    levels.push({
        name: 'Level 35',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 600, y: 200, w: 150, h: 30 },
            { x: 1200, y: 370, w: 200, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 300, y: 150 },
            { x: 500, y: 100 },
            { x: 900, y: 120 },
            { x: 1100, y: 180 }
        ],
        hazards: [
            { x: 250, y: 320, w: 100, h: 20 },
            { x: 450, y: 280, w: 20, h: 90 },
            { x: 850, y: 250, w: 20, h: 120 },
            { x: 1050, y: 300, w: 100, h: 20 }
        ],
        movingPlatforms: [
            { x: 180, y: 350, w: 100, h: 25, type: 'horizontal', range: 200, speed: 1.8 },
            { x: 800, y: 200, w: 100, h: 25, type: 'horizontal', range: 250, speed: 2.0 },
            { x: 400, y: 370, w: 80, h: 25, type: 'vertical', range: -180, speed: 1.5 },
            { x: 1000, y: 200, w: 80, h: 25, type: 'vertical', range: 170, speed: 1.5 }
        ],
        stars: [
            { x: 280, y: 280 },
            { x: 430, y: 150 },
            { x: 680, y: 140 },
            { x: 950, y: 130 },
            { x: 1100, y: 280 }
        ],
        door: { x: 1280, y: 310 }
    });

    // Level 36 - 빠른 움직이는 발판 + 좁은 통로
    levels.push({
        name: 'Level 36',
        spawn: { x: 50, y: 100 },
        platforms: [
            { x: 0, y: 150, w: 150, h: 30 },
            { x: 1400, y: 370, w: 200, h: 30 }
        ],
        walls: [
            { x: 350, y: 0, w: 20, h: 120 },
            { x: 350, y: 200, w: 20, h: 200 },
            { x: 700, y: 100, w: 20, h: 150 },
            { x: 700, y: 320, w: 20, h: 80 },
            { x: 1050, y: 0, w: 20, h: 180 },
            { x: 1050, y: 250, w: 20, h: 150 }
        ],
        anchors: [
            { x: 200, y: 50 },
            { x: 550, y: 80 },
            { x: 900, y: 50 },
            { x: 1250, y: 100 }
        ],
        hazards: [
            { x: 350, y: 120, w: 20, h: 80 },
            { x: 700, y: 250, w: 20, h: 70 },
            { x: 1050, y: 180, w: 20, h: 70 }
        ],
        movingPlatforms: [
            { x: 180, y: 150, w: 120, h: 25, type: 'horizontal', range: 150, speed: 2.5 },
            { x: 400, y: 180, w: 100, h: 25, type: 'vertical', range: 150, speed: 2.0 },
            { x: 750, y: 280, w: 100, h: 25, type: 'horizontal', range: 250, speed: 2.2 },
            { x: 1100, y: 250, w: 100, h: 25, type: 'vertical', range: 100, speed: 2.0 }
        ],
        stars: [
            { x: 280, y: 100 },
            { x: 500, y: 250 },
            { x: 850, y: 220 },
            { x: 1150, y: 300 }
        ],
        door: { x: 1480, y: 310 }
    });

    // Level 37 - 연속 점프 움직이는 발판
    levels.push({
        name: 'Level 37',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 120, h: 30 },
            { x: 2000, y: 370, w: 200, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 350, y: 200 },
            { x: 700, y: 180 },
            { x: 1050, y: 200 },
            { x: 1400, y: 180 },
            { x: 1750, y: 200 }
        ],
        hazards: [
            { x: 120, y: 395, w: 1880, h: 30 }
        ],
        movingPlatforms: [
            { x: 150, y: 350, w: 80, h: 25, type: 'vertical', range: -100, speed: 1.5 },
            { x: 350, y: 300, w: 80, h: 25, type: 'horizontal', range: 100, speed: 2.0 },
            { x: 550, y: 350, w: 80, h: 25, type: 'vertical', range: -120, speed: 1.8 },
            { x: 750, y: 280, w: 80, h: 25, type: 'horizontal', range: 100, speed: 2.2 },
            { x: 950, y: 350, w: 80, h: 25, type: 'vertical', range: -100, speed: 1.5 },
            { x: 1150, y: 300, w: 80, h: 25, type: 'horizontal', range: 100, speed: 2.0 },
            { x: 1350, y: 350, w: 80, h: 25, type: 'vertical', range: -120, speed: 1.8 },
            { x: 1550, y: 280, w: 80, h: 25, type: 'horizontal', range: 100, speed: 2.2 },
            { x: 1750, y: 350, w: 80, h: 25, type: 'vertical', range: -100, speed: 1.5 }
        ],
        stars: [
            { x: 250, y: 220 },
            { x: 500, y: 200 },
            { x: 850, y: 180 },
            { x: 1250, y: 200 },
            { x: 1650, y: 180 }
        ],
        door: { x: 2080, y: 310 }
    });

    // Level 38 - 원형 경로 도전
    levels.push({
        name: 'Level 38',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 150, h: 30 },
            { x: 1200, y: 370, w: 100, h: 30 },
            { x: 1200, y: 200, w: 100, h: 30 },
            { x: 600, y: 50, w: 150, h: 30 },
            { x: 0, y: 200, w: 100, h: 30 },
            { x: 550, y: 200, w: 150, h: 30 }
        ],
        walls: [],
        anchors: [
            { x: 400, y: 280 },
            { x: 800, y: 280 },
            { x: 1100, y: 150 },
            { x: 900, y: 0 },
            { x: 400, y: 0 },
            { x: 150, y: 100 },
            { x: 350, y: 150 }
        ],
        hazards: [
            { x: 300, y: 340, w: 20, h: 30 },
            { x: 700, y: 340, w: 20, h: 30 },
            { x: 1000, y: 340, w: 20, h: 30 },
            { x: 750, y: 20, w: 20, h: 30 },
            { x: 450, y: 20, w: 20, h: 30 }
        ],
        movingPlatforms: [
            { x: 200, y: 370, w: 100, h: 25, type: 'horizontal', range: 400, speed: 1.5 },
            { x: 700, y: 370, w: 100, h: 25, type: 'horizontal', range: 400, speed: 1.5 },
            { x: 1200, y: 300, w: 80, h: 25, type: 'vertical', range: -100, speed: 1.2 },
            { x: 800, y: 50, w: 100, h: 25, type: 'horizontal', range: -300, speed: 1.5 },
            { x: 0, y: 280, w: 80, h: 25, type: 'vertical', range: -80, speed: 1.2 }
        ],
        stars: [
            { x: 400, y: 300 },
            { x: 900, y: 300 },
            { x: 1230, y: 280 },
            { x: 700, y: -10 },
            { x: 50, y: 150 }
        ],
        door: { x: 590, y: 140 }
    });

    // Level 39 - 최종 도전 (모든 요소 조합)
    levels.push({
        name: 'Level 39',
        spawn: { x: 50, y: 320 },
        platforms: [
            { x: 0, y: 370, w: 120, h: 30 },
            { x: 500, y: 370, w: 80, h: 30 },
            { x: 900, y: 370, w: 80, h: 30 },
            { x: 1300, y: 250, w: 100, h: 30 },
            { x: 1700, y: 200, w: 100, h: 30 },
            { x: 2100, y: 100, w: 200, h: 30 }
        ],
        walls: [
            { x: 1250, y: 280, w: 20, h: 90 },
            { x: 1650, y: 230, w: 20, h: 70 }
        ],
        anchors: [
            { x: 300, y: 200 },
            { x: 700, y: 180 },
            { x: 1100, y: 150 },
            { x: 1500, y: 100 },
            { x: 1900, y: 50 },
            { x: 2000, y: 30 }
        ],
        hazards: [
            { x: 120, y: 395, w: 380, h: 25 },
            { x: 580, y: 395, w: 320, h: 25 },
            { x: 980, y: 395, w: 250, h: 25 },
            { x: 400, y: 300, w: 20, h: 70 },
            { x: 800, y: 280, w: 20, h: 90 },
            { x: 1200, y: 150, w: 20, h: 100 },
            { x: 1600, y: 100, w: 20, h: 100 },
            { x: 2000, y: 50, w: 20, h: 50 }
        ],
        movingPlatforms: [
            { x: 150, y: 350, w: 100, h: 25, type: 'horizontal', range: 250, speed: 2.0 },
            { x: 600, y: 350, w: 80, h: 25, type: 'horizontal', range: 220, speed: 2.2 },
            { x: 1000, y: 370, w: 80, h: 25, type: 'vertical', range: -130, speed: 1.5 },
            { x: 1420, y: 250, w: 80, h: 25, type: 'horizontal', range: 180, speed: 2.0 },
            { x: 1820, y: 200, w: 80, h: 25, type: 'vertical', range: -110, speed: 1.8 },
            { x: 1950, y: 100, w: 80, h: 25, type: 'horizontal', range: 130, speed: 2.5 }
        ],
        stars: [
            { x: 280, y: 280 },
            { x: 700, y: 260 },
            { x: 1050, y: 200 },
            { x: 1500, y: 180 },
            { x: 1850, y: 120 },
            { x: 2050, y: 40 }
        ],
        door: { x: 2180, y: 40 }
    });

    return levels;
}

const LEVELS = createLevels();

// ==================== INITIALIZATION ====================
function init() {
    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');

    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Keyboard
    document.addEventListener('keydown', (e) => {
        if (e.code === 'KeyA' || e.code === 'ArrowLeft') keys.left = true;
        if (e.code === 'KeyD' || e.code === 'ArrowRight') keys.right = true;
        if (e.code === 'Space') { keys.jump = true; e.preventDefault(); }
        if (e.code === 'Escape') {
            if (gameState === 'playing') {
                pauseGame();
            } else if (gameState === 'paused') {
                resumeGame();
            }
        }
    });
    document.addEventListener('keyup', (e) => {
        if (e.code === 'KeyA' || e.code === 'ArrowLeft') keys.left = false;
        if (e.code === 'KeyD' || e.code === 'ArrowRight') keys.right = false;
        if (e.code === 'Space') keys.jump = false;
    });

    // Mouse
    document.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mouseX = (e.clientX - rect.left) / rect.width * canvas.width + camera.x;
        mouseY = (e.clientY - rect.top) / rect.height * canvas.height + camera.y;
    });
    document.addEventListener('mousedown', (e) => {
        if (e.button === 0 && e.target.tagName !== 'BUTTON') {
            keys.grapple = true;
            if (gameState === 'playing') shootGrapple();
        }
    });
    document.addEventListener('mouseup', (e) => {
        if (e.button === 0) { keys.grapple = false; releaseGrapple(); }
    });

    // Touch
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        mouseX = (touch.clientX - rect.left) / rect.width * canvas.width + camera.x;
        mouseY = (touch.clientY - rect.top) / rect.height * canvas.height + camera.y;
        keys.grapple = true;
        if (gameState === 'playing') shootGrapple();
    }, { passive: false });
    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        keys.grapple = false;
        releaseGrapple();
    }, { passive: false });

    // Buttons
    document.getElementById('start-btn').addEventListener('click', startGame);
    document.getElementById('retry-btn').addEventListener('click', restartLevel);
    document.getElementById('next-level-btn').addEventListener('click', nextLevel);
    document.getElementById('resume-btn').addEventListener('click', resumeGame);
    document.getElementById('restart-btn').addEventListener('click', restartLevel);
    document.getElementById('stage-select-btn').addEventListener('click', goToStageSelect);

    // 스테이지 선택 드롭다운 채우기
    populateStageSelector();

    requestAnimationFrame(gameLoop);
}

function populateStageSelector() {
    const selector = document.getElementById('stage-selector');
    selector.innerHTML = '<option value="0">Tutorial</option>';

    // 레벨 1부터 (LEVELS.length - 1)까지 추가
    for (let i = 1; i < LEVELS.length; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Level ${i}`;
        selector.appendChild(option);
    }
}

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Reload level if game is playing to adjust y positions
    if (gameState === 'playing' && LEVELS[currentLevel]) {
        loadLevel(currentLevel);
    }
}

// ==================== GAME CONTROLS ====================
function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    // 선택한 스테이지로 시작
    const selector = document.getElementById('stage-selector');
    currentLevel = parseInt(selector.value) || 0;
    loadLevel(currentLevel);
    gameState = 'playing';
}

function restartLevel() {
    document.getElementById('game-over-screen').classList.add('hidden');
    loadLevel(currentLevel);
    gameState = 'playing';
}

function nextLevel() {
    document.getElementById('level-complete-screen').classList.add('hidden');
    currentLevel++;
    if (currentLevel >= LEVELS.length) currentLevel = 1;
    loadLevel(currentLevel);
    gameState = 'playing';
}

function pauseGame() {
    gameState = 'paused';
    const levelDisplay = currentLevel === 0 ? 'Tutorial' : currentLevel;
    document.getElementById('pause-level').textContent = levelDisplay;
    document.getElementById('pause-screen').classList.remove('hidden');
}

function resumeGame() {
    document.getElementById('pause-screen').classList.add('hidden');
    gameState = 'playing';
}

function goToStageSelect() {
    document.getElementById('pause-screen').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
    // 현재 레벨을 선택 상태로 설정
    document.getElementById('stage-selector').value = currentLevel;
    gameState = 'start';
}

function loadLevel(num) {
    const level = LEVELS[num];

    // Calculate y offset to position level at bottom of screen
    const groundY = canvas.height - 150;
    const baseY = 370; // Original base y in level data
    const yOffset = groundY - baseY;

    platforms = level.platforms.map(p => ({ ...p, y: p.y + yOffset }));
    walls = level.walls.map(w => ({ ...w, y: w.y + yOffset }));
    anchors = level.anchors.map(a => ({ ...a, y: a.y + yOffset, radius: 18 }));
    stars = level.stars.map(s => ({
        ...s,
        y: s.y + yOffset,
        collected: false,
        radius: 18,
        active: s.active !== false // 기본값은 true, 명시적으로 false인 경우만 비활성화
    }));

    // 버튼 로드
    if (level.buttons) {
        buttons = level.buttons.map(b => ({
            ...b,
            y: b.y + yOffset,
            width: 40,
            height: 15,
            pressed: false
        }));
    } else {
        buttons = [];
    }

    // 위험요소 로드 (빨간 발판/벽)
    if (level.hazards) {
        hazards = level.hazards.map(h => ({
            ...h,
            y: h.y + yOffset
        }));
    } else {
        hazards = [];
    }

    // 움직이는 발판 로드
    if (level.movingPlatforms) {
        movingPlatforms = level.movingPlatforms.map(mp => ({
            ...mp,
            y: mp.y + yOffset,
            originX: mp.x,
            originY: mp.y + yOffset,
            direction: 1,
            offset: 0
        }));
    } else {
        movingPlatforms = [];
    }

    door = { ...level.door, y: level.door.y + yOffset, width: 50, height: 70, open: false };
    spawnPoint = { x: level.spawn.x, y: level.spawn.y + yOffset };
    totalStars = stars.length;
    collectedStars = 0;

    if (level.isTutorial) {
        tutorialStep = 0;
        tutorialActions = { moved: false, jumped: false, wallJumped: false, grappled: false, swung: false, collected: false };
    }

    resetPlayer();
    grapple.active = false;
    grapple.attached = false;
    camera.x = 0;
    camera.y = 0;
    updateUI();
}

function resetPlayer() {
    player.x = spawnPoint.x;
    player.y = spawnPoint.y;
    player.vx = 0;
    player.vy = 0;
    player.onGround = false;
    player.onWall = 0;
    player.facingRight = true;
}

// ==================== GRAPPLING ====================
function shootGrapple() {
    if (grapple.attached) return;
    grapple.active = true;
    grapple.attached = false;
    grapple.x = player.x + player.width / 2;
    grapple.y = player.y + 5;
    const dx = mouseX - grapple.x;
    const dy = mouseY - grapple.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < 1) {
        grapple.active = false;
        return;
    }
    grapple.vx = (dx / dist) * CONFIG.ropeSpeed;
    grapple.vy = (dy / dist) * CONFIG.ropeSpeed;
}

function releaseGrapple() {
    if (grapple.attached) {
        // Gentle momentum boost on release
        player.vx *= 1.1;
        player.vy *= 1.1;
    }
    grapple.active = false;
    grapple.attached = false;
}

function updateGrapple() {
    if (!grapple.active) return;

    if (!grapple.attached) {
        grapple.x += grapple.vx;
        grapple.y += grapple.vy;

        const dx = grapple.x - (player.x + player.width / 2);
        const dy = grapple.y - (player.y + 5);
        if (Math.sqrt(dx * dx + dy * dy) > CONFIG.maxRopeLength) {
            grapple.active = false;
            return;
        }

        for (const anchor of anchors) {
            const ax = grapple.x - anchor.x;
            const ay = grapple.y - anchor.y;
            if (Math.sqrt(ax * ax + ay * ay) < anchor.radius + 8) {
                grapple.attached = true;
                grapple.anchorX = anchor.x;
                grapple.anchorY = anchor.y;
                grapple.ropeLength = Math.sqrt(
                    Math.pow(player.x + player.width / 2 - anchor.x, 2) +
                    Math.pow(player.y + 5 - anchor.y, 2)
                );
                tutorialActions.grappled = true;
                return;
            }
        }

        for (const plat of platforms) {
            if (grapple.x > plat.x && grapple.x < plat.x + plat.w &&
                grapple.y > plat.y && grapple.y < plat.y + plat.h) {
                grapple.active = false;
                return;
            }
        }
    }
}

// ==================== PHYSICS ====================
function updateMovingPlatforms() {
    for (const mp of movingPlatforms) {
        const prevX = mp.x;
        const prevY = mp.y;

        mp.offset += mp.speed * mp.direction;
        const minRange = Math.min(0, mp.range);
        const maxRange = Math.max(0, mp.range);
        if (mp.offset >= maxRange || mp.offset <= minRange) {
            mp.direction *= -1;
            mp.offset = Math.max(minRange, Math.min(mp.offset, maxRange));
        }

        if (mp.type === 'horizontal') {
            mp.x = mp.originX + mp.offset;
        } else {
            mp.y = mp.originY + mp.offset;
        }

        mp.deltaX = mp.x - prevX;
        mp.deltaY = mp.y - prevY;
    }
}

function updatePhysics() {
    // 움직이는 발판 업데이트
    updateMovingPlatforms();

    // Movement
    if (!grapple.attached) {
        if (keys.left) {
            player.vx = -CONFIG.moveSpeed;
            player.facingRight = false;
            tutorialActions.moved = true;
        } else if (keys.right) {
            player.vx = CONFIG.moveSpeed;
            player.facingRight = true;
            tutorialActions.moved = true;
        } else {
            player.vx *= player.onGround ? CONFIG.friction : CONFIG.airResistance;
        }
    } else {
        // Swing (pendulum style)
        const dx = player.x + player.width / 2 - grapple.anchorX;
        const dy = player.y - grapple.anchorY;
        const angle = Math.atan2(dy, dx);

        // Apply swing force with damping (A=왼쪽, D=오른쪽)
        if (keys.left) {
            player.vx -= CONFIG.swingForce * 1.5;
            tutorialActions.swung = true;
        }
        if (keys.right) {
            player.vx += CONFIG.swingForce * 1.5;
            tutorialActions.swung = true;
        }

        // Apply damping for smoother swing
        player.vx *= CONFIG.swingDamping;
        player.vy *= CONFIG.swingDamping;
    }

    // Gravity
    player.vy += CONFIG.gravity;

    // Wall slide
    if (player.onWall !== 0 && player.vy > 0 && !player.onGround) {
        player.vy = Math.min(player.vy, CONFIG.wallSlideSpeed);
    }

    // Jump
    if (keys.jump && player.wallJumpCooldown <= 0) {
        if (player.onGround) {
            player.vy = CONFIG.jumpForce;
            player.onGround = false;
            tutorialActions.jumped = true;
        } else if (player.onWall !== 0) {
            player.vx = CONFIG.wallJumpForce.x * -player.onWall;
            player.vy = CONFIG.wallJumpForce.y;
            player.wallJumpCooldown = 10;
            player.facingRight = player.onWall < 0;
            tutorialActions.wallJumped = true;
        }
        keys.jump = false;
    }
    if (player.wallJumpCooldown > 0) player.wallJumpCooldown--;

    // Grapple constraint (pendulum - 180 degree limit)
    if (grapple.attached) {
        let dx = player.x + player.width / 2 - grapple.anchorX;
        let dy = player.y - grapple.anchorY;

        // Limit to 180 degrees (can't go above anchor)
        if (dy < 0) {
            player.y = grapple.anchorY;
            if (player.vy < 0) {
                // Convert upward velocity to horizontal (swing momentum)
                player.vx += (player.vy * -0.5) * Math.sign(dx);
                player.vy = 0;
            }
            dy = 0;
        }

        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > grapple.ropeLength) {
            const angle = Math.atan2(dy, dx);
            player.x = grapple.anchorX + Math.cos(angle) * grapple.ropeLength - player.width / 2;
            player.y = grapple.anchorY + Math.sin(angle) * grapple.ropeLength;
            const dot = player.vx * Math.cos(angle) + player.vy * Math.sin(angle);
            if (dot > 0) {
                player.vx -= dot * Math.cos(angle);
                player.vy -= dot * Math.sin(angle);
            }
        }
    }

    player.x += player.vx;
    player.y += player.vy;

    checkCollisions();
    updateCamera();
    updateGrapple();

    // Death
    if (player.y > canvas.height + 100) gameOver();

    // Hazards - 빨간 발판/벽 충돌 시 즉사
    for (const hazard of hazards) {
        if (player.x + player.width > hazard.x && player.x < hazard.x + hazard.w &&
            player.y + player.height > hazard.y && player.y < hazard.y + hazard.h) {
            gameOver();
            return;
        }
    }

    // Buttons - 버튼 충돌 감지 및 별 활성화
    for (const button of buttons) {
        if (button.pressed) continue;
        // 플레이어가 버튼 위에 있는지 확인 (더 넓은 범위로 감지)
        const playerCenterX = player.x + player.width / 2;
        const buttonCenterX = button.x + button.width / 2;
        const horizontalOverlap = Math.abs(playerCenterX - buttonCenterX) < (player.width / 2 + button.width / 2);
        const verticalNear = player.y + player.height >= button.y - 5 &&
                            player.y + player.height <= button.y + button.height + 20;

        if (horizontalOverlap && verticalNear && player.onGround) {
            button.pressed = true;
            // 연결된 별 활성화 (단일 인덱스 또는 배열 지원)
            if (button.targetStarIndex !== undefined) {
                if (Array.isArray(button.targetStarIndex)) {
                    for (const idx of button.targetStarIndex) {
                        if (stars[idx]) stars[idx].active = true;
                    }
                } else if (stars[button.targetStarIndex]) {
                    stars[button.targetStarIndex].active = true;
                }
            }
        }
    }

    // Stars - active 상태인 별만 수집 가능
    for (const star of stars) {
        if (star.collected) continue;
        if (!star.active) continue; // 비활성화된 별은 수집 불가
        const dx = (player.x + player.width / 2) - star.x;
        const dy = (player.y + player.height / 2) - star.y;
        if (Math.sqrt(dx * dx + dy * dy) < star.radius + 20) {
            star.collected = true;
            collectedStars++;
            tutorialActions.collected = true;
            if (collectedStars >= totalStars) door.open = true;
            updateUI();
        }
    }

    // Door
    if (door.open) {
        const dx = (player.x + player.width / 2) - (door.x + door.width / 2);
        const dy = (player.y + player.height / 2) - (door.y + door.height / 2);
        if (Math.abs(dx) < 30 && Math.abs(dy) < 40) levelComplete();
    }
}

function checkCollisions() {
    player.onGround = false;
    player.onWall = 0;

    // 플랫폼 충돌 (위에서 착지 + 아래에서 머리 부딪힘)
    for (const plat of platforms) {
        if (player.x + player.width > plat.x && player.x < plat.x + plat.w) {
            // 위에서 착지 (기존)
            if (player.vy >= 0 && player.y + player.height > plat.y && player.y + player.height < plat.y + plat.h + 10) {
                player.y = plat.y - player.height;
                player.vy = 0;
                player.onGround = true;
                if (grapple.attached) {
                    grapple.active = false;
                    grapple.attached = false;
                }
            }
            // 아래에서 머리 부딪힘 (새로 추가)
            else if (player.vy < 0 && player.y < plat.y + plat.h && player.y > plat.y) {
                player.y = plat.y + plat.h;
                player.vy = 0;
            }
        }
    }

    // 움직이는 발판 충돌
    for (const mp of movingPlatforms) {
        if (player.x + player.width > mp.x && player.x < mp.x + mp.w) {
            if (player.vy >= 0 && player.y + player.height > mp.y && player.y + player.height < mp.y + mp.h + 10) {
                player.y = mp.y - player.height;
                player.vy = 0;
                player.onGround = true;
                // 플레이어를 플랫폼과 함께 이동
                player.x += mp.deltaX || 0;
                player.y += mp.deltaY || 0;
                if (grapple.attached) {
                    grapple.active = false;
                    grapple.attached = false;
                }
            }
            else if (player.vy < 0 && player.y < mp.y + mp.h && player.y > mp.y) {
                player.y = mp.y + mp.h;
                player.vy = 0;
            }
        }
    }

    // 벽 충돌 (좌우 + 상하)
    for (const wall of walls) {
        // 수평 충돌 (좌우)
        if (player.y + player.height > wall.y && player.y < wall.y + wall.h) {
            // 오른쪽에서 벽 왼쪽에 부딪힘
            if (player.x + player.width > wall.x && player.x + player.width < wall.x + wall.w / 2 + 10) {
                player.x = wall.x - player.width;
                player.vx = 0;
                player.onWall = 1;
            }
            // 왼쪽에서 벽 오른쪽에 부딪힘
            else if (player.x < wall.x + wall.w && player.x > wall.x + wall.w / 2 - 10) {
                player.x = wall.x + wall.w;
                player.vx = 0;
                player.onWall = -1;
            }
        }

        // 수직 충돌 (상하) - 벽 위/아래로 통과 방지
        if (player.x + player.width > wall.x && player.x < wall.x + wall.w) {
            // 아래에서 벽 바닥에 부딪힘
            if (player.vy < 0 && player.y < wall.y + wall.h && player.y > wall.y + wall.h - 20) {
                player.y = wall.y + wall.h;
                player.vy = 0;
            }
            // 위에서 벽 위에 착지
            else if (player.vy >= 0 && player.y + player.height > wall.y && player.y + player.height < wall.y + 20) {
                player.y = wall.y - player.height;
                player.vy = 0;
                player.onGround = true;
            }
        }
    }
}

function updateCamera() {
    const targetX = player.x - canvas.width / 3;
    const targetY = player.y - canvas.height / 2;
    camera.x += (targetX - camera.x) * 0.08;
    camera.y += (targetY - camera.y) * 0.08;
    // 카메라 x 제한 제거 - 음수 좌표 레벨 지원
}

// ==================== RENDERING ====================
function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Background
    const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
    grad.addColorStop(0, '#0f0c29');
    grad.addColorStop(0.5, '#302b63');
    grad.addColorStop(1, '#24243e');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Only draw game elements when playing or paused
    if (gameState !== 'playing' && gameState !== 'paused') return;

    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Platforms
    ctx.fillStyle = '#4a4a6a';
    for (const p of platforms) {
        ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.fillStyle = '#6a6a8a';
        ctx.fillRect(p.x, p.y, p.w, 4);
        ctx.fillStyle = '#4a4a6a';
    }

    // 움직이는 발판
    for (const mp of movingPlatforms) {
        ctx.save();
        ctx.shadowColor = '#4aa8ff';
        ctx.shadowBlur = 12;
        ctx.fillStyle = '#3a8ad4';
        ctx.fillRect(mp.x, mp.y, mp.w, mp.h);
        ctx.fillStyle = '#6abfff';
        ctx.fillRect(mp.x, mp.y, mp.w, 4);
        ctx.strokeStyle = '#2a6aaa';
        ctx.lineWidth = 1;
        ctx.strokeRect(mp.x, mp.y, mp.w, mp.h);
        ctx.restore();
    }

    // Walls
    ctx.fillStyle = '#5a5a7a';
    for (const w of walls) {
        ctx.fillRect(w.x, w.y, w.w, w.h);
    }

    // Hazards (빨간 발판/벽) - 깔끔한 빨간색 직사각형
    for (const h of hazards) {
        ctx.save();
        // 글로우 효과
        ctx.shadowColor = '#ff0000';
        ctx.shadowBlur = 20;
        // 메인 빨간 색상
        ctx.fillStyle = '#e74c3c';
        ctx.fillRect(h.x, h.y, h.w, h.h);
        // 테두리
        ctx.strokeStyle = '#c0392b';
        ctx.lineWidth = 2;
        ctx.strokeRect(h.x, h.y, h.w, h.h);
        // 하이라이트 (위쪽)
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(h.x + 2, h.y + 2, h.w - 4, 3);
        ctx.restore();
    }

    // Anchors
    for (const a of anchors) {
        ctx.beginPath();
        ctx.arc(a.x, a.y, a.radius * 1.8, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
        ctx.fill();
        ctx.beginPath();
        ctx.arc(a.x, a.y, a.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#667eea';
        ctx.fill();
    }

    // Buttons - 버튼 렌더링
    for (const btn of buttons) {
        ctx.save();
        if (btn.pressed) {
            // 눌린 버튼 - 납작하게
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(btn.x, btn.y + 10, btn.width, 5);
        } else {
            // 안 눌린 버튼 - 튀어나온 형태
            ctx.fillStyle = '#e74c3c';
            ctx.shadowColor = '#e74c3c';
            ctx.shadowBlur = 10;
            ctx.fillRect(btn.x, btn.y, btn.width, btn.height);
            // 버튼 위 하이라이트
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(btn.x + 2, btn.y + 2, btn.width - 4, 4);
        }
        ctx.restore();
    }

    // Stars - 활성화/비활성화 상태에 따라 다르게 렌더링
    for (const s of stars) {
        if (s.collected) continue;
        ctx.save();
        ctx.translate(s.x, s.y);

        // 별 모양 경로 생성
        ctx.beginPath();
        for (let i = 0; i < 10; i++) {
            const angle = (i * Math.PI) / 5 - Math.PI / 2;
            const r = i % 2 === 0 ? s.radius : s.radius * 0.4;
            if (i === 0) ctx.moveTo(Math.cos(angle) * r, Math.sin(angle) * r);
            else ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r);
        }
        ctx.closePath();

        if (s.active) {
            // 활성화된 별 - 채워진 금색
            ctx.fillStyle = '#ffd700';
            ctx.shadowColor = '#ffd700';
            ctx.shadowBlur = 15;
            ctx.fill();
        } else {
            // 비활성화된 별 - 윤곽선만 (회색 투명)
            ctx.strokeStyle = 'rgba(150, 150, 150, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 3]); // 점선
            ctx.stroke();
            ctx.setLineDash([]); // 점선 해제
        }
        ctx.restore();
    }

    // Door
    if (door) {
        ctx.fillStyle = door.open ? '#2ecc71' : '#7f8c8d';
        ctx.fillRect(door.x, door.y, door.width, door.height);
        if (door.open) {
            ctx.shadowColor = '#2ecc71';
            ctx.shadowBlur = 20;
            ctx.strokeStyle = '#2ecc71';
            ctx.lineWidth = 3;
            ctx.strokeRect(door.x, door.y, door.width, door.height);
            ctx.shadowBlur = 0;
        }
    }

    // Grapple
    if (grapple.active) {
        ctx.strokeStyle = '#ffd700';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(player.x + player.width / 2, player.y + 5);
        ctx.lineTo(grapple.attached ? grapple.anchorX : grapple.x, grapple.attached ? grapple.anchorY : grapple.y);
        ctx.stroke();
    }

    // Player (stickman)
    drawPlayer();

    ctx.restore();

    // Tutorial overlay
    if (LEVELS[currentLevel]?.isTutorial) drawTutorial();

    // Button level tutorial - 버튼 레벨 안내
    if (LEVELS[currentLevel]?.isButtonLevel) drawButtonTutorial();

    // Hazard level tutorial - 위험요소 안내
    if (LEVELS[currentLevel]?.tutorial && hazards.length > 0) drawHazardTutorial();
}

function drawPlayer() {
    const x = player.x + player.width / 2;
    const y = player.y + player.height / 2;

    ctx.save();
    ctx.translate(x, y);
    if (!player.facingRight) ctx.scale(-1, 1);

    ctx.strokeStyle = '#ffd700';
    ctx.fillStyle = '#ffd700';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.shadowColor = '#ffd700';
    ctx.shadowBlur = 10;

    const head = 8, body = 18, limb = 14;
    let armL = 0.5, armR = 0.5, legL = 0.3, legR = 0.3;
    let bodyTilt = 0;
    let headOffset = 0;

    const t = Date.now() * 0.012;
    const speed = Math.abs(player.vx);

    if (grapple.attached) {
        // 줄타기: 몸이 줄 방향으로 기울어짐
        const ropeAngle = Math.atan2(
            grapple.anchorY - (player.y + 5),
            grapple.anchorX - (player.x + player.width / 2)
        );
        bodyTilt = Math.sin(ropeAngle) * 0.3;
        armL = -1.2;
        armR = -1.0;
        legL = 0.4 + Math.sin(t * 2) * 0.2;
        legR = 0.4 - Math.sin(t * 2) * 0.2;
    } else if (player.onWall !== 0) {
        // 벽타기: 벽에 붙은 자세
        armL = -0.3;
        armR = -0.5;
        legL = 0.2;
        legR = 0.5;
        bodyTilt = player.onWall * 0.15;
    } else if (!player.onGround) {
        if (player.vy < -5) {
            // 점프 상승: 팔 위로, 다리 웅크림
            armL = -0.6;
            armR = -0.4;
            legL = 0.8;
            legR = 0.9;
        } else if (player.vy > 3) {
            // 낙하: 팔 벌리고, 다리 펴짐
            armL = 1.0 + Math.sin(t * 3) * 0.2;
            armR = 1.2 + Math.sin(t * 3 + 1) * 0.2;
            legL = 0.2;
            legR = 0.4;
        } else {
            // 공중 유지
            armL = 0.8;
            armR = 0.9;
            legL = 0.5;
            legR = 0.6;
        }
    } else if (speed > 0.5) {
        // 걷기/뛰기 애니메이션
        const walkSpeed = speed > 3 ? 0.025 : 0.018;
        const walkT = Date.now() * walkSpeed;
        const intensity = Math.min(speed / 4, 1);

        // 팔다리 교차 움직임
        armL = Math.sin(walkT) * 0.7 * intensity;
        armR = Math.sin(walkT + Math.PI) * 0.7 * intensity;
        legL = Math.sin(walkT + Math.PI) * 0.5 * intensity;
        legR = Math.sin(walkT) * 0.5 * intensity;

        // 달릴 때 몸 약간 앞으로
        bodyTilt = intensity * 0.1;
        headOffset = Math.sin(walkT * 2) * 1.5 * intensity;
    } else {
        // 서있기: 가만히 숨쉬는 모션
        const breathe = Math.sin(t * 0.5) * 0.05;
        armL = 0.4 + breathe;
        armR = 0.5 + breathe;
        legL = 0.2;
        legR = 0.25;
    }

    // 몸 기울기 적용
    ctx.rotate(bodyTilt);

    // 머리
    ctx.beginPath();
    ctx.arc(0, -body - head + headOffset, head, 0, Math.PI * 2);
    ctx.fill();

    // 몸통
    ctx.beginPath();
    ctx.moveTo(0, -body);
    ctx.lineTo(0, 0);
    ctx.stroke();

    // 팔
    ctx.beginPath();
    ctx.moveTo(0, -body + 3);
    ctx.lineTo(limb * Math.cos(armL), -body + 3 + limb * Math.sin(armL));
    ctx.moveTo(0, -body + 3);
    ctx.lineTo(-limb * Math.cos(armR), -body + 3 + limb * Math.sin(armR));
    ctx.stroke();

    // 다리
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(limb * 0.9 * Math.cos(0.3 + legL), limb * 0.9 * Math.sin(0.3 + legL) + 3);
    ctx.moveTo(0, 0);
    ctx.lineTo(-limb * 0.9 * Math.cos(0.3 + legR), limb * 0.9 * Math.sin(0.3 + legR) + 3);
    ctx.stroke();

    ctx.restore();
}

function drawTutorial() {
    let msg = '';
    if (!tutorialActions.moved) msg = 'A / D 키로 좌우 이동';
    else if (!tutorialActions.jumped) msg = 'Space로 점프';
    else if (!tutorialActions.grappled) msg = '파란 공을 향해 마우스 클릭으로 줄 발사';
    else if (!tutorialActions.swung) msg = '매달린 상태에서 A / D로 흔들기';
    else if (!tutorialActions.collected) msg = '별을 모아 문을 열어요';
    else if (collectedStars < totalStars) msg = '남은 별을 모두 모으세요';
    else msg = '초록색 문으로 들어가세요!';

    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    const w = 450, h = 50;
    ctx.fillRect(canvas.width / 2 - w / 2, 20, w, h);
    ctx.strokeStyle = '#667eea';
    ctx.lineWidth = 2;
    ctx.strokeRect(canvas.width / 2 - w / 2, 20, w, h);
    ctx.fillStyle = '#fff';
    ctx.font = '20px Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText(msg, canvas.width / 2, 52);
}

function drawButtonTutorial() {
    // 모든 버튼이 눌렸는지 확인
    const allButtonsPressed = buttons.every(b => b.pressed);
    // 모든 별이 활성화됐는지 확인
    const allStarsActive = stars.every(s => s.active);

    let msg = '';
    if (!allButtonsPressed) {
        msg = '🔴 빨간 버튼을 밟아 별을 활성화하세요!';
    } else if (!allStarsActive) {
        msg = '⭐ 별이 활성화되었습니다! 별을 모으세요!';
    } else if (collectedStars < totalStars) {
        msg = '⭐ 활성화된 별을 모두 모으세요!';
    } else {
        msg = '🚪 모든 별을 모았습니다! 문으로 이동하세요!';
    }

    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    const w = 450, h = 50;
    ctx.fillRect(canvas.width / 2 - w / 2, 20, w, h);
    ctx.strokeStyle = '#e74c3c';
    ctx.lineWidth = 2;
    ctx.strokeRect(canvas.width / 2 - w / 2, 20, w, h);
    ctx.fillStyle = '#fff';
    ctx.font = '20px Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText(msg, canvas.width / 2, 52);
}

function drawHazardTutorial() {
    const msg = LEVELS[currentLevel]?.tutorial || '⚠️ 빨간 발판/벽에 닿으면 죽습니다!';

    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    const w = 500, h = 50;
    ctx.fillRect(canvas.width / 2 - w / 2, 20, w, h);
    ctx.strokeStyle = '#e74c3c';
    ctx.lineWidth = 2;
    ctx.strokeRect(canvas.width / 2 - w / 2, 20, w, h);
    ctx.fillStyle = '#fff';
    ctx.font = '18px Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText(msg, canvas.width / 2, 52);
}

// ==================== GAME STATE ====================
function gameOver() {
    gameState = 'gameOver';
    document.getElementById('final-score').textContent = LEVELS[currentLevel]?.name || currentLevel;
    document.getElementById('game-over-screen').classList.remove('hidden');
}

function levelComplete() {
    gameState = 'levelComplete';
    document.getElementById('completed-level').textContent = LEVELS[currentLevel]?.name || currentLevel;
    document.getElementById('level-complete-screen').classList.remove('hidden');
}

function updateUI() {
    // 레벨 번호만 표시 (Tutorial은 0, 나머지는 1부터 시작하는 번호)
    const levelDisplay = currentLevel === 0 ? 'Tutorial' : currentLevel;
    document.getElementById('level-num').textContent = levelDisplay;
    document.getElementById('score').textContent = `${collectedStars}/${totalStars}`;
}

// ==================== GAME LOOP ====================
function gameLoop() {
    if (gameState === 'playing') updatePhysics();
    render();
    requestAnimationFrame(gameLoop);
}

document.addEventListener('DOMContentLoaded', () => {
    init();
    // 스플래시 화면 숨기기 (1.5초 후)
    setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) {
            splash.classList.add('hidden');
            // 시작 화면 보이기
            document.getElementById('start-screen').classList.remove('hidden');
        }
    }, 1500);
});

// ==================== REFRESH WARNING ====================
// 게임 진행 중 새로고침 시 경고 메시지 표시
window.addEventListener('beforeunload', function(e) {
    // 게임이 시작 화면이 아닌 경우에만 경고 표시
    if (gameState === 'playing' || gameState === 'levelComplete' || gameState === 'paused') {
        e.preventDefault();
        // 표준 방식으로 경고 메시지 설정
        e.returnValue = '게임 진행 상황이 초기화됩니다. 정말 나가시겠습니까?';
        return e.returnValue;
    }
});
